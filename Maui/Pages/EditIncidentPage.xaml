<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Maui.ViewModels"
             xmlns:models="clr-namespace:Shared.Models.Enums;assembly=Shared"
             xmlns:maps="clr-namespace:Microsoft.Maui.Controls.Maps;assembly=Microsoft.Maui.Controls.Maps"
             x:Class="Maui.Pages.EditIncidentPage"
             Title="Edit Incident">

    <ScrollView>
        <Grid RowDefinitions="Auto,*" Padding="15">
            <!-- Loading Indicator -->
            <ActivityIndicator Grid.Row="0"
                             IsVisible="{Binding IsLoading}"
                             IsRunning="{Binding IsLoading}"
                             HorizontalOptions="Center"
                             VerticalOptions="Center" />

            <!-- Edit Form -->
            <VerticalStackLayout Grid.Row="1" 
                               IsVisible="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}"
                               Spacing="15">

                <!-- Title -->
                <Label Text="Title"
                       FontAttributes="Bold" />
                <Entry Text="{Binding Title, Mode=TwoWay}"
                       IsEnabled="{Binding IsCreator}"
                       Placeholder="Enter title" />

                <!-- Description -->
                <Label Text="Description"
                       FontAttributes="Bold" />
                <Editor Text="{Binding Description, Mode=TwoWay}"
                        HeightRequest="100"
                        Placeholder="Enter description">
                    <Editor.IsEnabled>
                        <MultiBinding Converter="{StaticResource OrBoolConverter}">
                            <Binding Path="IsCreator" />
                            <Binding Path="IsAssignedFieldEmployee" />
                        </MultiBinding>
                    </Editor.IsEnabled>
                </Editor>

                <!-- Status -->
                <Label Text="Status"
                       FontAttributes="Bold" />
                <Frame BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}"
                       Padding="15,10"
                       HasShadow="False"
                       BorderColor="Transparent"
                       Opacity="0.7">
                    <Label Text="{Binding Status, Mode=OneWay}"
                           TextColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                           FontSize="16"
                           Opacity="0.7" />
                </Frame>

                <!-- Priority -->
                <Label Text="Priority"
                       FontAttributes="Bold" />
                <Frame BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}"
                       Padding="15,10"
                       HasShadow="False"
                       BorderColor="Transparent"
                       Opacity="0.7">
                    <Label Text="{Binding Priority, Mode=OneWay}"
                           TextColor="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                           FontSize="16"
                           Opacity="0.7" />
                </Frame>

                <!-- Address -->
                <Label Text="Address"
                       FontAttributes="Bold" />
                <Entry Text="{Binding Address, Mode=TwoWay}"
                       IsEnabled="{Binding IsCreator}"
                       Placeholder="Enter street address" />

                <!-- Zip Code -->
                <Label Text="Zip Code"
                       FontAttributes="Bold" />
                <Entry Text="{Binding ZipCode, Mode=TwoWay}"
                       IsEnabled="{Binding IsCreator}"
                       Placeholder="Enter zip code" />

                <!-- Address Validation -->
                <Button Text="Validate Address"
                        Command="{Binding ValidateAddressCommand}"
                        IsEnabled="{Binding IsCreator}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White" />

                <Label Text="{Binding AddressValidationMessage}"
                       TextColor="{Binding IsAddressValid, Converter={StaticResource BoolToColorConverter}}"
                       IsVisible="{Binding AddressValidationMessage, Converter={StaticResource StringNotEmptyConverter}}" />

                <!-- Map -->
                <maps:Map x:Name="LocationMap"
                         IsVisible="{Binding ShowMap}"
                         ItemsSource="{Binding MapPins}"
                         IsEnabled="False"
                         IsShowingUser="False"
                         HeightRequest="200"
                         Loaded="OnMapLoaded" />

                <!-- Save Button -->
                <Button Text="Save Changes"
                        Command="{Binding SaveCommand}"
                        IsEnabled="{Binding CanSave}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        Margin="0,20,0,0">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button"
                                   Binding="{Binding CanSave}"
                                   Value="False">
                            <Setter Property="Opacity" Value="0.7" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>
            </VerticalStackLayout>
        </Grid>
    </ScrollView>
</ContentPage> 