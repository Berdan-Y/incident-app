@page "/login"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Blazor.Components
@using Blazor.Components.Services
@using Blazor.Components.Models
@using MudBlazor
@using System.ComponentModel.DataAnnotations
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject AuthService AuthService

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudPaper Class="pa-4" Elevation="3">
        <MudStack>
            <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">Login</MudText>
            
            <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
                <DataAnnotationsValidator />
                <MudStack>
                    <MudTextField @bind-Value="loginModel.Email"
                                Label="Email"
                                Variant="Variant.Outlined"
                                Required="true"
                                RequiredError="Email is required!"
                                Class="mt-3" />

                    <MudTextField @bind-Value="loginModel.Password"
                                Label="Password"
                                Variant="Variant.Outlined"
                                Required="true"
                                RequiredError="Password is required!"
                                InputType="InputType.Password"
                                Class="mt-3" />

                    <MudButton ButtonType="ButtonType.Submit"
                              Variant="Variant.Filled"
                              Color="Color.Secondary"
                              FullWidth="true"
                              Class="mt-4"
                              Disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Color="Color.Secondary" Size="Size.Small" Indeterminate="true" Class="ms-n1" />
                            <MudText Class="ms-2">Logging in...</MudText>
                        }
                        else
                        {
                            <MudText>Login</MudText>
                        }
                    </MudButton>
                </MudStack>
            </EditForm>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private LoginModel loginModel = new();
    private bool _isLoading;

    private async Task HandleLogin()
    {
        try
        {
            _isLoading = true;
            var result = await AuthService.Login(loginModel.Email, loginModel.Password);
            NavigationManager.NavigateTo("/");
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email format")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Password is required")]
        [MinLength(4, ErrorMessage = "Password must be at least 4 characters")]
        public string Password { get; set; } = "";
    }
} 